ejs=function(){function require(p){if("fs"==p)return{};var path=require.resolve(p),mod=require.modules[path];if(!mod)throw new Error('failed to require "'+p+'"');return mod.exports||(mod.exports={},mod.call(mod.exports,mod,mod.exports,require.relative(path))),mod.exports}return require.modules={},require.resolve=function(path){var orig=path,reg=path+".js",index=path+"/index.js";return require.modules[reg]&&reg||require.modules[index]&&index||orig},require.register=function(path,fn){require.modules[path]=fn},require.relative=function(parent){return function(p){if("."!=p.substr(0,1))return require(p);var path=parent.split("/"),segs=p.split("/");path.pop();for(var i=0;i<segs.length;i++){var seg=segs[i];".."==seg?path.pop():"."!=seg&&path.push(seg)}return require(path.join("/"))}},require.register("ejs.js",function(module,exports,require){function filtered(js){return js.split("|").reduce(function(js,filter){var parts=filter.split(":"),name=parts.shift(),args=parts.shift()||"";return args&&(args=", "+args),"filters."+name+"("+js+args+")"})}function rethrow(err,str,filename,lineno){var lines=str.split("\n"),start=Math.max(lineno-3,0),end=Math.min(lines.length,lineno+3),context=lines.slice(start,end).map(function(line,i){var curr=i+start+1;return(curr==lineno?" >> ":"    ")+curr+"| "+line}).join("\n");throw err.path=filename,err.message=(filename||"ejs")+":"+lineno+"\n"+context+"\n\n"+err.message,err}var utils=require("./utils"),fs=require("fs"),path=require("path"),XRegExp=require("xregexp").XRegExp;exports.version="0.7.2";var filters=exports.filters=require("./filters"),cache={};exports.clearCache=function(){cache={}},Token=function(type,text,lineno,meta,children){this.type=type,this.text=text,this.lineno=lineno,this.meta=meta,this.children=children};var Parser=exports.Parser=function(options){this.options=options||{},this.delimiter={open:XRegExp.escape(options.open||exports.open||"<%"),close:XRegExp.escape(options.close||exports.close||"%>")},this.keyword={block:"block",end:"end","extends":"extends",include:"include"},this.viewsDir=options.viewsDir?options.viewsDir:""};Parser.prototype.parse=function(str,blocks,layout){var blocks=blocks?blocks:[],pre=["var buf = [];","\nwith (locals) {","\n  buf.push('"],post=["');\n}\nreturn buf.join('');"],tokens=this.tokenize(str,blocks),buf=this.convertTokens(tokens,blocks);return layout||(buf=pre.concat(buf,post)),buf.join("")},Parser.prototype.convertTokens=function(tokens,blocks){var buf=[],consumeEOL=!1;for(var i=0;i<tokens.length;i++){var token=tokens[i],res="",line="__stack.lineno="+token.lineno;switch(token.type){case"literal":res=token.text,consumeEOL&&(res=XRegExp.replace(res,/\n/,"","one"),consumeEOL=!1),res=res.replace(/\\/g,"\\\\").replace(/\'/g,"\\'").replace(/\r/g,"").replace(/\n/g,"\\n");break;case"code":var prefix="');"+line+";",postfix="; buf.push('",js=token.text;token.meta&&token.meta.buffered&&(token.meta.escaped?(prefix="', escape(("+line+", ",postfix=")), '"):(prefix="', ("+line+", ",postfix="), '"),token.meta.filtered&&(js=filtered(js))),res=prefix+js+postfix;break;case"consume-EOL":consumeEOL=!0;break;case this.keyword.extends:var filename=path.join(this.viewsDir,token.text),js=fs.readFileSync(filename,"utf8");res=this.parse(js,blocks,!0);break;case this.keyword.block:buf.push.apply(buf,this.convertTokens(token.children,blocks))}buf.push(res)}return buf},Parser.prototype.tokenize=function(str,blocks){var tokens=[],myBlocks=[],lineno=1,stack=[],layout=!1,ejsRE=XRegExp.cache("^(?<op>[=-](?<filter>:)?)?(?<body>.*?)\\s*(?<slurp>-)?$","mn"),keywordRE=XRegExp.cache("^\\s*((?<end>"+this.keyword.end+")|((?<keyword>("+this.keyword.extends+")|("+this.keyword.block+")|("+this.keyword.include+"))(\\s+(?<name>.*?))?))\\s*$","mn"),segments=XRegExp.matchRecursive(str,this.delimiter.open,this.delimiter.close,"g",{valueNames:["literal","open","ejs","close"]});for(var i=0;i<segments.length;i++){var segment=segments[i],slurp=!1;switch(segment.value){case"literal":tokens.push(new Token("literal",segment.name,lineno));break;case"ejs":var match=XRegExp.exec(segment.name,ejsRE,"m");if(!match)throw new Error("Incorrect syntax for ejs...");if(match.op)tokens.push(new Token("code",match.body,lineno,{buffered:!0,escaped:match.op[0]=="="?!0:!1,filtered:match.filter?!0:!1}));else{var kwMatch=XRegExp.exec(match.body,keywordRE,"m");if(kwMatch)if(kwMatch.keyword)switch(kwMatch.keyword){case this.keyword.block:if(!kwMatch.name)throw new Error("Must specify name for block...");var isArgument=layout&&stack.length==0?!0:!1;stack.push({token:new Token(this.keyword.block,kwMatch.name,lineno,{isArgument:isArgument}),tokensBuf:tokens,keyword:this.keyword.block}),tokens=[];break;case this.keyword.extends:if(!kwMatch.name)throw new Error("Must specify filename after extends...");tokens.push(new Token(this.keyword.extends,kwMatch.name,lineno)),layout=!0;break;case this.keyword.include:if(!kwMatch.name)throw new Error("Must specify file to include...");var filename=path.join(this.viewsDir,kwMatch.name),includedEjs=fs.readFileSync(filename,"utf8");this.options.debug&&console.log("Including: \n"+includedEjs),tokens.push.apply(tokens,this.tokenize(includedEjs));break;default:throw new Error("Invalid keyword: "+kwMatch.keyword)}else{if(!kwMatch.end)throw new Error("Unexpected error, probably a bug in the parser!");var parent=stack.pop();if(!parent)throw new Error("Encountered "+this.keyword.end+" without matching block statement.");parent.token.children=tokens,tokens=parent.tokensBuf,blocks[parent.token.text]?tokens.push(blocks[parent.token.text]):parent.token.meta.isArgument?myBlocks[parent.token.text]=parent.token:tokens.push(parent.token)}else tokens.push(new Token("code",match.body,lineno))}match.slurp&&(slurp=!0);break;default:}slurp&&tokens.push(new Token("consume-EOL","",lineno));var n=0;while(~(n=segment.name.indexOf("\n",n)))n++,lineno++}if(stack.length!=0)throw new Error("Unmatched "+stack.pop().keyword+" statment...");for(var x in myBlocks)blocks[x]=myBlocks[x];return tokens};var parse=exports.parse=function(str,options){return(new Parser(options)).parse(str)},compile=exports.compile=function(str,options){options=options||{};var input=JSON.stringify(str),filename=options.filename?JSON.stringify(options.filename):"undefined";str=["var __stack = { lineno: 1, input: "+input+", filename: "+filename+" };",rethrow.toString(),"try {",exports.parse(str,options),"} catch (err) {","  rethrow(err, __stack.input, __stack.filename, __stack.lineno);","}"].join("\n"),options.debug&&console.log(str);var fn=new Function("locals, filters, escape",str);return function(locals){return fn.call(this,locals,filters,utils.escape)}};exports.render=function(str,options){var fn,options=options||{};if(options.cache){if(!options.filename)throw new Error('"cache" option requires "filename".');fn=cache[options.filename]||(cache[options.filename]=compile(str,options))}else fn=compile(str,options);return options.__proto__=options.locals,fn.call(options.scope,options)},exports.renderFile=function(path,options,fn){var key=path+":string";"function"==typeof options&&(fn=options,options={}),options.filename=path;try{var str=options.cache?cache[key]||(cache[key]=fs.readFileSync(path,"utf8")):fs.readFileSync(path,"utf8");fn(null,exports.render(str,options))}catch(err){fn(err)}},exports.__express=exports.renderFile,require.extensions?require.extensions[".ejs"]=function(module,filename){source=require("fs").readFileSync(filename,"utf-8"),module._compile(compile(source,{}),filename)}:require.registerExtension&&require.registerExtension(".ejs",function(src){return compile(src,{})})}),require.register("filters.js",function(module,exports,require){exports.first=function(obj){return obj[0]},exports.last=function(obj){return obj[obj.length-1]},exports.capitalize=function(str){return str=String(str),str[0].toUpperCase()+str.substr(1,str.length)},exports.downcase=function(str){return String(str).toLowerCase()},exports.upcase=function(str){return String(str).toUpperCase()},exports.sort=function(obj){return Object.create(obj).sort()},exports.sort_by=function(obj,prop){return Object.create(obj).sort(function(a,b){return a=a[prop],b=b[prop],a>b?1:a<b?-1:0})},exports.size=exports.length=function(obj){return obj.length},exports.plus=function(a,b){return Number(a)+Number(b)},exports.minus=function(a,b){return Number(a)-Number(b)},exports.times=function(a,b){return Number(a)*Number(b)},exports.divided_by=function(a,b){return Number(a)/Number(b)},exports.join=function(obj,str){return obj.join(str||", ")},exports.truncate=function(str,len){return str=String(str),str.substr(0,len)},exports.truncate_words=function(str,n){var str=String(str),words=str.split(/ +/);return words.slice(0,n).join(" ")},exports.replace=function(str,pattern,substitution){return String(str).replace(pattern,substitution||"")},exports.prepend=function(obj,val){return Array.isArray(obj)?[val].concat(obj):val+obj},exports.append=function(obj,val){return Array.isArray(obj)?obj.concat(val):obj+val},exports.map=function(arr,prop){return arr.map(function(obj){return obj[prop]})},exports.reverse=function(obj){return Array.isArray(obj)?obj.reverse():String(obj).split("").reverse().join("")},exports.get=function(obj,prop){return obj[prop]},exports.json=function(obj){return JSON.stringify(obj)}}),require.register("utils.js",function(module,exports,require){exports.escape=function(html){return String(html).replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}),require("ejs")}();